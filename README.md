# TulSUAttendanceBot

**Телеграм-бот для автоматизации учёта посещаемости студентов по расписанию Тульского государственного университета.**

---

## Возможности

* Автоматическая отправка опросов перед началом пары
* Настройка дисциплин для администраторов
* Сбор и архивирование ответов студентов
* Формирование отчётов о посещаемости в виде Excel-файлов (xlsx)
* Поддержка тестового режима с имитацией расписания
* Кэширование расписания и автоматический рефреш перед началом пары
* Гибкая конфигурация через переменные окружения

---

## Требования

* Python ≥ 3.10
* Доступ в интернет для получения расписания и работы бота

---

## Установка

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/kyoug3n/TulSUAttendanceBot.git
   cd TulSUAttendanceBot
   ```

2. Создайте и активируйте виртуальное окружение:

   ```bash
   python3 -m venv venv
   source venv/bin/activate  # Linux/macOS
   venv\Scripts\activate     # Windows
   ```

3. Установите зависимости:

   ```bash
   pip install -r requirements.txt
   ```

4. Скопируйте пример файла с настройками:

   ```bash
   cp .env.example .env
   ```

---

## Конфигурация

В файле `.env` необходимо задать следующие переменные:

| Переменная                 | Описание                                                                       | Пример          |
|----------------------------|--------------------------------------------------------------------------------|-----------------|
| `TOKEN`                    | Токен вашего бота (@BotFather)                                                 | `123456:ABC...` |
| `CHAT_ID`                  | ID группы, где публикуются опросы                                              | `-12345`        |
| `GROUP_ID`                 | Номер учебной группы для получения расписания                                  | `111111`        |
| `ADMIN_COMMANDS_ACCESS`    | Список Telegram ID администраторов для управления дисциплинами                 | `123,1234`      |
| `TEST_MODE`                | Режим тестирования (`True`/`False`), использует фиктивное расписание           | `False`         |
| `POLL_CHECK_INTERVAL`      | Интервал (в секундах) между проверками необходимости отправить опрос           | `60`            |
| `POLL_CLOSURE_WINDOW`      | Окно (в секундах) до начала пары, в котором отправляется опрос                 | `300`           |
| `SCHEDULE_PREFETCH_OFFSET` | Сдвиг (в секундах) перед началом пары для предзагрузки и обновления расписания | `300`           |
| `INCLUDE_EXAMS`            | Включать экзамены и зачёты в расписание (`True`/`False`)                       | `False`         |
| `NMG_TYPES`                | Список типов занятий, имеющих несколько подгрупп (доп. конфигурация в боте)    | `practice,lab`  |

Для переменной `NMG_TYPES` используются следующие значения, которые соответствуют типам занятий:

| Тип занятий | Читаемое описание       |
|-------------|-------------------------|
| `lecture`   | Лекции                  |
| `practice`  | Практические занятия    |          |
| `lab`       | Лабораторные занятия    |          |
| `default`   | Экзамены, зачёты и т.п. |          |

---

## Запуск

```bash
python main.py
```

При первом запуске бот создаёт базу данных `db.sqlite3` и инициализирует таблицы.

---

## Команды бота

| Команда                      | Описание                                                                                         |
|------------------------------|--------------------------------------------------------------------------------------------------|
| `/start`                     | Запуск регистрации или отображение состояния бота                                                |
| `/edit_name`                 | Изменить фамилию и имя                                                                           |
| `/display_name`              | Показать сохранённые фамилию и имя                                                               |
| `/export_attendance YYYY-MM` | Экспорт отчёта за указанный месяц                                                                |
| `/manage_disciplines`        | (Только администраторы) Открыть меню управления дисциплинами (сокращения, исключения, подгруппы) |

---

## Структура проекта

```
TulSUAttendanceBot/
├── .env.example           # Пример конфига
├── main.py                # Точка входа, маршруты и логика бота
├── parser.py              # Получение и парсинг/кэширование расписания с API ТулГУ
├── scheduler.py           # Планировщик: предзагрузка расписания, отправка и закрытие опросов
├── storage.py             # Менеджер хранения данных в SQLite (пользователи, опросы, настройки дисциплин, кэш)
├── test_schedule.py       # Генератор тестового расписания для отладки
├── requirements.txt       # Список зависимостей
└── db.sqlite3             # Файл БД (создаётся автоматически)
```

---

## Лицензия

MIT License. Детали в файле [LICENSE](LICENSE).

---

## Контрибьютинг

1. Форкните репозиторий
2. Создайте новую ветку: `git checkout -b feature/YourFeature`
3. Внесите изменения и сделайте коммит
4. Отправьте ветку в свой форк и создайте Pull Request
